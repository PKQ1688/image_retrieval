#### 第一步、安装GPU版本的Milvus
- 安装请参考[链接](https://milvus.io/cn/docs/v0.8.0/guides/get_started/install_milvus/gpu_milvus_docker.md)

- 配置更改
请根据表格中的值修改/home/$USER/milvus/conf下的文件server_config.yaml

| 参数 | 设置值 | 
| :----| :---- | 
| cpu_cache_capacity | 40 （确保服务器内存大于该值） | 
| gpu_resource_config.enable | true | 
| cache_capacity | 4（确保服务器显存大于该值） | 
| build_index_resources | - gpu0 |

修改完成后重启Milvus服务
```
# 重启Milvus服务
$ docker restart milvus_gpu
```

#### 第二步、安装Mysql
```shell
# 启动mysql
$ docker run -p 3306:3306 -e MYSQL_ROOT_PASSWORD=milvus2020 -v /home/$USER/mysql:/var/lib/mysql -d --name mysql mysql:latest
# 进入mysql容器
$ docker exec -it mysql bash
# 进入Mysql交互界面
$ mysql -h 127.0.0.1 -uroot -milvus2020
# 在Mysql交互界面执行以下命令
> use mysql;
> SET GLOBAL local_infile=1;
> alter user 'root'@'%' identified with mysql_native_password by 'milvus2020';
> create table if not exists milvus_image (milvus_id bigint, images_id varchar(30), index ix_milvus (milvus_id), index ix_images (images_id));
```



#### 第三步、启动以图搜图服务
```shell
# 登录镜像仓库，密码是miao@1233
$ docker login --username=524966200@qq.com registry.cn-hangzhou.aliyuncs.com
# 拉取镜像
$ docker pull registry.cn-hangzhou.aliyuncs.com/xzzzh/pic_search:v7
# 启动服务
$ docker run --gpus '"device=1"' -d -it --restart=always -p 18052:5000 --name pic_search_gpu -e MILVUS_HOST=Milvus服务监听的IP -e MYSQL_HOST=mysql服务监听的IP -e MYSQL_PWD=milvus2020 registry.cn-hangzhou.aliyuncs.com/xzzzh/pic_search:v7


```
docker run命令参数介绍
- --gpus '"device=1"'，表示服务使用编号为1的显卡
- -p 5000:5000，表示服务启动端口映射到宿主机的5000端口
- -e MILVUS_HOST=，变量值应设置为第一步中Milvus容器启动所在的宿主机的IP，注意如果Milvus服务与以图搜图服务都启动在同一台宿主机上的话，该变量对应的值也不要设置为127.0.0.1
- -e MILVUS_PORT=，变量值默认为19530，如果第一步中没有修改Milvus服务的端口，该变量可以不设置
- -e MYSQL_HOST=，变量值应设置为第二步中Mysql容器启动所在的宿主机的IP，注意如果Mysql服务与以图搜图服务都启动在同一台宿主机上的话，该变量对应的值也不要设置为127.0.0.1
- -e MYSQL_PORT=，变量值默认为3306，如果第二步中没有修改Mysql容器的端口，该变量可以不设置
- -e MYSQL_USER=，变量值默认为root，该变量一般情况下不需要修改
- -e MYSQL_PWD=，变量值默认为123456，这是因为第二步中创建Mysql容器时指定了root用户的密码为123456，如果第二步中root用户的密码更改了，那么启动容器时需要加上该变量
- -e MYSQL_DB=，变量值默认为mysql，该变量一般情况下不需要修改

#### 第四步、启动本地客户端命令
```shell
python app.py
```
